#!/bin/bash
#
# ===== HPCINSTALL BUILD SCRIPT
#
#HPCI -n 
#HPCI -v
#HPCI -l ncarenv
#HPCI -l @CMOD
#HPCI -l ncarcompilers
#HPCI -l @MMOD
#HPCI -a 

#	Maintainer: Brian Vanderwende
#	Revised:    11:51, 24 Jul 2017

# ===== BUILD CONFIGURATION

# Module configuration
#   SWTYPE determines module location: idep, compiler, dcomp, dmpi, pythonpkgs, none
#   SWDESC provides "Help" description of software (use \n\n for paragraphs)
#   SWSITE provides "Help" website for software
#   SWLIBS provides library calls necessary to compile against software
SWTYPE=
SWDESC=
SWSITE=
SWLIBS=

# Autogenerated identifier variables
SWNAME=${HPCI_SW_NAME##*/}
SWVERS=${HPCI_SW_VERSION%%-*}
SWTAG=${SWNAME}-$SWVERS

# Define build itinerary
SWPKGS[0]=${SWTAG}

# Define how each component will be built
#   Options: autotools, make, cmake, perl, setuptools, wheel, custom
SWBTOOL[0]=

echo -e "\n>>> BEGINNING BUILD [${SWTAG}]\n"

# Set compiler specific settings
case $LMOD_FAMILY_COMPILER in
	gnu)
		echo "Building with GNU compilers ..."
		;;
	intel)
		echo "Building with Intel compilers ..."

		export CC=icc
		export CXX=icpc
		export FC=ifort
		;;
	pgi)
		echo "Building with PGI compilers ..."

		export CC=pgcc
		export CXX=pgc++
		export FC=pgif90
		;;
	*)
		;;
esac

# If MPI program, use those wrappers
if [[ $SWTYPE == dmpi ]]; then
	echo "Using MPI wrappers ..."

	export CC=mpicc
	export CXX=mpicxx
	export FC=mpif90
fi

# If python package, get version and adjust SWTYPE
if [[ $SWTYPE == pythonpkgs ]]; then
	PYMAJOR=$(grep -oP 'python/.{0,3}' <<< $LOADEDMODULES | tr -d [h-y,/])

	if [[ $HOSTNAME == [cl]* ]]; then
		SWTYPE=
	fi

	if [[ $PYMAJOR == 3.* ]]; then
		VECMD=pyvenv
	else
		VECMD=virtualenv
	fi

	echo "Building for Python ${PYMAJOR} ..."
fi

# ===== BUILD EACH SOFTWARE PACKAGE AS SCHEDULED

function run_cmd {
	CMD=$1 CMDNAME=$1

	if [[ ! -z "$2" ]]; then
		CMDNAME=$2
	fi

	echo -e "\n>>> RUNNING COMMAND [${CMDNAME}]\n"

	eval $CMD
	CMDCODE=${PIPESTATUS[0]}

	if [[ $CMDCODE != 0 ]]; then
		echo -e "\n*** ERROR: $CMDNAME exited with code ${CMDCODE}! Exiting ..."
		exit 1
	fi
}

# Make build directory to store source files since HPCI won't do it until later
mkdir -p ${HPCI_SW_DIR}/BUILD_DIR

for P in ${!SWPKGS[@]}; do
	PKG=${SWPKGS[$P]}
	echo -e "\n$((P + 1))) BUILDING PACKAGE [${PKG}] ...\n"
	
	# Unpackage source files
	echo "Preparing source files ..."
	rm -rf source-$PKG
	PKGSRC=$(ls -d -1 $PKG ${PKG}.[!0-9]* 2> /dev/null | head -1)

	if [[ -e $PKGSRC ]]; then
		case $PKGSRC in
			*.tar* | *.tgz)
				tar -xvf $PKGSRC > /dev/null
				mv $PKG source-$PKG
				;;
			*.zip)
				unzip -d source $PKGSRC > /dev/null
				mv $PKG source-$PKG
				;;
			*)
				cp -r $PKGSRC source-$PKG
				;;
		esac
	else
		echo -e "\n*** ERROR: source for $PKG does not exist! Exiting ..."
		exit 1
	fi

	cd source-$PKG

# ===== BUILD AND INSTALL THE SOFTWARE

	# Define settings and prepare source files for package
	case $PKG in
		${SWTAG})
			export CPPFLAGS=
			BUILDOPTS=
			;;
		*)
			;;
	esac

	# Build the package using specified build mechanism
	BTOOL=${SWBTOOL[$P]}
	echo "Using ${BTOOL} ..."

	case $BTOOL in
		autotools)
			mkdir -p m4
			
			if [[ -f autogen.sh ]]; then
				run_cmd ./autogen.sh
			else
				run_cmd "libtoolize -f --copy"
				run_cmd "aclocal -I m4 --install --force"
				run_cmd "autoheader -f"
				run_cmd "autoconf -f"
				run_cmd "automake -af --copy"
			fi
			;&
		make)
			run_cmd "./configure --prefix=$HPCI_SW_DIR $BUILDOPTS"
			run_cmd "make"
			run_cmd "make install" make-install
			;;
		cmake)
			mkdir build; cd build
			BUILDOPTS="-DCMAKE_INSTALL_PREFIX=$HPCI_SW_DIR $BUILDOPTS"
			
			run_cmd "cmake $BUILDOPTS .."
			run_cmd "cmake --build . --target install" cmake-install
			;;
		perl)
			run_cmd "perl Makefile.PL PREFIX=$HPCI_SW_DIR $BUILDOPTS" perl-config
			run_cmd make perl-make
			run_cmd "make install" perl-install
			;;
		setuptools)
			mkdir -p ${HPCI_SW_DIR}/lib/python${PYMAJOR}/site-packages
			export PYTHONPATH=${HPCI_SW_DIR}/lib/python${PYMAJOR}/site-packages:$PYTHONPATH

			run_cmd "python${PYMAJOR} setup.py build $BUILDOPTS" python-build
			run_cmd "python${PYMAJOR} setup.py install --prefix=$HPCI_SW_DIR" python-install
			;;
		wheel)
			# Build wheel in a virtual environment
			$VECMD --system-site-packages hpci_env
			source hpci_env/bin/activate
			run_cmd "python${PYMAJOR} setup.py bdist_wheel --dist-dir=${HPCI_SW_DIR}/wheel $BUILDOPTS" python-wheel
			deactivate
			
			# Install wheel to system library
			cd $HPCI_SW_DIR
			WHEEL=$(ls wheel/ | cut -d '-' -f 1)
			run_cmd "pip${PYMAJOR} --no-cache-dir install --prefix . --no-index -f wheel ${WHEEL}" python-install
			cd - > /dev/null
			;;
		custom)
			;;
	esac

	cd ..
done

echo -e "\n<<< BUILD COMPLETE!\n"

# ===== CLEAN FILES

echo "Cleaning source files ..."
rm -rf source-*

# ===== INSTALL THE MODULE

if [[ $SWTYPE == none ]]; then
	exit 0
fi

# Set path for the module file
if [[ $HOSTNAME == [jy]* ]] && [[ $USER != csgteam ]]; then
	MODPATH=$HPCI_MOD_DIR
else
	if [[ $SWTYPE == d* ]]; then
		MODPATH=$HPCI_MOD_DIR_CDEP
	else
		MODPATH=${HPCI_MOD_DIR}/$SWTYPE
	fi
fi

MODPATH=${MODPATH}/$HPCI_SW_NAME
MODFILE=${MODPATH}/${HPCI_SW_VERSION}.lua
WRAPNAME=${SWNAME//[^A-Za-z0-9]/}

echo "Configuring and installing modulefile ..."
echo "Path: ${MODFILE}"

# Configure the module file for this particular build
# Need to ensure group write access so git repository is consistent
umask 0002
mkdir -p $MODPATH

# Write the module file template for this software
cat > $MODFILE << EOF
require("posix")

-- The message printed by the module whatis command
whatis("${SWNAME} v${HPCI_SW_VERSION}")

-- The message printed by the module help command
help([[
$(echo -e ${SWDESC} | fmt -s)

Software website - ${SWSITE}

Built on $(date)
Modules used:
EOF

# Write out list of build dependencies
module list 2>&1 | awk -F '[0-9, ][0-9])' '{for(i=2;i<=NF;i++) {print "  "$i}}' >> $MODFILE

cat >> $MODFILE << EOF
]])

-- Set prerequisites and conflicts
prereq(${HPCI_MOD_PREREQ})
conflict("")

-- Set paths for software binaries, libraries, headers, and manuals
local basepath = "${HPCI_SW_DIR}"
local binpath  = pathJoin(basepath, "/bin")             -- binaries
local libpath  = pathJoin(basepath, "/lib")             -- libraries
local incpath  = pathJoin(basepath, "/include")         -- include files
local manpath  = pathJoin(basepath, "/share/man")       -- man pages
local pypath   = pathJoin(basepath, "/lib/python${PYMAJOR}/site-packages")
local libs     = "${SWLIBS}"

-- Update the binary and manual paths in user environment
prepend_path("PATH", binpath)
prepend_path("PYTHONPATH", pypath)
prepend_path("MANPATH", manpath)

-- Configure NCAR compiler wrappers to use headers and libraries
EOF

if [[ $HOSTNAME == [jy]* ]]; then
cat >> $MODFILE << EOF
prepend_path("INC_NCAR", "-I" .. incpath, " ")
prepend_path("LIB_NCAR", "-L" .. libpath .. " " .. libs .. " -Wl,-rpath," .. libpath, " ")
EOF
else
cat >> $MODFILE << EOF
setenv("NCAR_INC_${WRAPNAME^^}", incpath)
setenv("NCAR_LDFLAGS_${WRAPNAME^^}", libpath)
setenv("NCAR_LIBS_${WRAPNAME^^}", libs)
EOF
fi
